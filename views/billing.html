<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing Dashboard</title>
    <link rel="stylesheet" href="/style.css">
    <link rel="stylesheet" href="/billing.css">
    <link rel="stylesheet" href="/login_style.css">
    
    <link rel="shortcut icon" as="image" href="/images/apple-touch-icon.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;600;700&family=Mulish&display=swap"
    rel="stylesheet">
    <link rel="stylesheet"
    href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@40,600,0,0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.3.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="container">
            <a href="#" class="logo">
                <img src="/images/logo.png" width="128" height="63" alt="AutoElite home">
            </a>
            <nav class="navbar" data-navbar>
                <ul class="navbar-list">
                    <li><a href="index.html" class="navbar-link">Home</a></li>
                    <li><a href="about.html" class="navbar-link">About</a></li>
                    <li><a href="services.html" class="navbar-link">Services</a></li>
                    <li>
                        <a href="contact.html" class="navbar-link">Contact Us</a>
                    </li>
                    <li><a href="billing.html" class="navbar-link">Billing</a></li>
                    <li><a href="users.html" class="navbar-link">Users</a></li>
                </ul>
            </nav>
            <a href="login.html" id="loginButton" class="btn btn-primary" >
                <span class="span" id="loginButtonText">Login</span>
                <span class="material-symbols-rounded">arrow_forward</span>
            </a>
            <button class="nav-toggle-btn" aria-label="toggle menu" data-nav-toggler>
                <span class="nav-toggle-icon icon-1"></span>
                <span class="nav-toggle-icon icon-2"></span>
                <span class="nav-toggle-icon icon-3"></span>
            </button>
        </div>
    </header>
    <main>
        <article>
            <section class="billing billing-image" style="background-image:url('/images/billing-cover.jpg')">
                <div class="myContainer">
                    <h1 class="h1 section-title">Billing Dashboard</h1>
                        <button id="createInvoiceButton">Create Invoice</button>

                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Invoice ID</th>
                                        <th>Client</th>
                                        <th>Email</th>
                                        <th>Car Model</th>
                                        <th>Car Color</th>
                                        <th>Licence Plate</th>
                                        <th>Date</th>
                                        <th>Time</th>
                                        <th>Labor Cost</th>
                                        <th>Tax</th>
                                        <th>Total</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="invoiceTableBody">
                                    <!--Invoices will be added here -->
                                </tbody>
                            </table>

                        </div>
                        <p id="errorDisplay" style="color: red; display: none;"></p>
                    
                </div>
            </section>
            <div id="invoicePopup" class="popup" style="display: none;">
                <div class="popup-content" id="invoicePopupContent">
                    <span class="close">&times;</span>
                    <h2 id="formTitle">Create Invoice</h2>
                    <form id="invoiceForm">
                        <input type="hidden" id="invoiceId" name="invoiceId">
                        <label for="clientName">Client Name:</label>
                        <input type="text" id="clientName" name="clientName" required>
                        <br>
                        <label for="email">Email (optional):</label>
                        <input type="email" id="email" name="email" list="emailList">
                        <datalist id="emailList"></datalist>
                        <br>
                        <label for="laborCost">Labor Cost:</label>
                        <input type="number" id="laborCost" name="laborCost" required>
                        <br>
                        <label for="carModel">Car Model:</label>
                        <input type="text" id="carModel" name="carModel" required>
                        <br>
                        <label for="carColor">Car Color:</label>
                        <input type="text" id="carColor" name="carColor" required>
                        <br>
                        <label for="licence plate">Licence Plate:</label>
                        <input type="text" id="licencePlate" name="licencePlate" required>
                        <br>
                        <div id="itemsContainer">
                            <div class="item">
                                <label for="description1">Description:</label>
                                <br>
                                <input type="text" id="description1" name="description1" required>
                                <br>
                                <label for="quantity1">Quantity:</label>
                                <br>
                                <input type="number" id="quantity1" name="quantity1" required>
                                <br>
                                <label for="price1">Unit Price:</label>
                                <br>
                                <input type="number" id="price1" name="price1" required>
                            </div>
                        </div>
                        <div class="button-group">
                            <button type="button" id="addItemButton" class="btnInvoice">Add Item</button>
                            <button type="submit" id="submitInvoiceButton" class="btnInvoice">Create Invoice</button>
                            <button type="button" id="cancelEditButton" class="btnInvoice" style="display: none;">Cancel</button>
                        </div>
                    </form>
                </div>
            </div>
            <div id="invoiceDetailsPopup" class="popup">
                <div class="popup-content">
                    <span class="close" id="closePopup">&times;</span>
                    <h2>Invoice Details</h2>
                    <div id="invoiceDetails"></div>
                    <div class="button-group">
                        <button id="downloadPdfButton" class="btnInvoice">Download PDF</button>
                        <button id="editInvoiceButton" class="btnInvoice">Edit Invoice</button>
                        <button id="deleteInvoiceButton" class="btnInvoice">Delete Invoice</button>
                    </div>
                </div>
            </div>
        </article>
    </main>
    <footer class="footer">
        <div class="footer-top section">
            <div class="container">
                <div class="footer-brand">
                    <a href="#" class="logo">
                        <img src="/images/logo.png" width="128" height="63"
                        alt="autoelite home">
                    </a>
                    <p class="footer-text">
                        voluptates repudiandae sint et molestiae non recusandae. Itaque earum rerum hic tenetur a sapiente delectus, ut aut reiciendis 
                        voluptatibus maiores alias consequatur aut perferendis.
                    </p>

                    <ul class="social-list">
                        <li>
                            <a href="#" class="social-link">
                                <img src="/images/facebook.svg" alt="facebook">
                            </a>
                        </li>

                        <li>
                            <a href="#" class="social-link">
                                <img src="/images/instagram.svg" alt="instagram">
                            </a>
                        </li>

                        <li>
                            <a href="#" class="social-link">
                                <img src="/images/twitter.svg" alt="twitter">
                            </a>
                        </li>
                    </ul>
                </div>

                <ul class="footer-list">
                    <li>
                        <p class="h3">Opening Hours</p>
                    </li>

                    <li>
                        <p class="p">Monday to Friday</p>
                        <span class="span" id="span-time">10:00 - 18:00</span>
                    </li>
                    <li>
                        <p class="p">Saturday - Sunday</p>
                        <span class="span" id="span-time">10:00 - 13:00</span>
                    </li>
                </ul>

                <ul class="footer-list">
                    <li>
                        <p class="h3">Contact Info</p>
                    </li>

                    <li>
                        <a href="tel:+01234567890" class="footer-link">
                            <span class="material-symbols-rounded">call</span>
                            <span class="span">+01 2 3456 7890</span>
                        </a>
                    </li>

                    <li>
                        <a href="mailto:info@autoelite.com" class="footer-link">
                            <span class="material-symbols-rounded">call</span>
                            <span class="span">info@autoelite.com</span>
                        </a>
                    </li>

                    <li>
                        <address class="footer-link address">
                            <span class="material-symbols-rounded">location_on</span>
                            <span class="span"> 3354 Sources Blvd, Dollard-Des Ormeaux, Quebec</span>
                        </address>
                    </li>
                </ul>
            </div>

            <img src="./images/footer-shape-3.png" width="637" height="173"
            loading="lazy" alt="Shape" class="shape shape-3 move-anim">


        </div>

        <div class="footer-bottom">
            <div class="container">
                <p class="copyright">Copyright 2024, All Rights Reserved.</p>
                <img src="/images/footer-shape-2.png" width="778" height="335"
                loading="lazy" alt="Shape"
                class="shape shape-2">

                <img src="/images/footer-shape-2.png" width="805" height="652"
                loading="lazy" alt="Red Car"
                class="shape shape-1 move anim">
                
            </div>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <script>
        const navbar = document.querySelector("[data-navbar]");
        const navToggler = document.querySelector("[data-nav-toggler]");
    
        navToggler.addEventListener("click", function () {
            navbar.classList.toggle("active");
            this.classList.toggle("active");
        });

        document.addEventListener("DOMContentLoaded", ()=>{
            const token = localStorage.getItem("token");
            const loginButton = document.getElementById("loginButton");
            const loginButtonText = document.getElementById("loginButtonText");
            const createInvoiceButton = document.getElementById("createInvoiceButton");
            const invoicePopup = document.getElementById ("invoicePopup");  
            const invoiceForm = document.getElementById("invoiceForm");
            const addItemButton = document.getElementById("addItemButton");
            const itemsContainer = document.getElementById("itemsContainer");
            const closePopu = document.getElementById("closePopup");
            const downloadPdfButton = document.getElementById("downloadPdfButton");
            const cancelEditButton = document.getElementById("cancelEditButton");
            const submitInvoiceButton = document.getElementById("submitInvoiceButton");
            const editInvoiceButton = document.getElementById("editInvoiceButton");
            const deleteInvoiceButton = document.getElementById("deleteInvoiceButton");
            const formTitle = document.getElementById("formTitle");
            const invoiceIdInput = document.getElementById("invoiceId");

            const { jsPDF } = window.jspdf;
            let editingInvoiceId = null;
            let currentInvoice = null; 

            if(token) {
                loginButtonText.textContent = "Logout";
                loginButton.addEventListener("click", (event)=>{
                    event.preventDefault();
                    localStorage.removeItem("token");
                    window.location.href = "/";
                });
            }else {
                loginButtonText.textContent = "Login";
                loginButton.href = "login.html";
            }

            createInvoiceButton.addEventListener("click", () =>{
                openInvoiceForm();
                document.body.classList.add("freeze-scroll");
            });

            document.querySelector(".close").addEventListener("click", ()=>{
                closeInvoiceForm();
                document.body.classList.remove("freeze-scroll");
            });
            closePopup.addEventListener("click", ()=>{
                closeInvoiceDetails();
                document.body.classList.remove("freeze-scroll");
            });
            


            window.addEventListener("click", (event)=>{
                if(event.target == document.getElementById("invoicePopup")) {
                    closeInvoiceForm();
                    document.body.classList.remove("freeze-scroll");
                }

                if (event.target == invoiceDetailsPopup) {
                    closeInvoiceDetails();
                    document.body.classList.remove("freeze-scroll");
                }
            });

            addItemButton.addEventListener("click", ()=>{
                const itemIndex = itemsContainer.children.length + 1;
                const newItem = document.createElement("div");
                newItem.classList.add("item");
                newItem.innerHTML = `
                    <label for="description${itemIndex}">Description:</label>
                    <input type="text" id="description${itemIndex}" name="description${itemIndex}" required>
                    <label for="quantity${itemIndex}">Quantity:</label>
                    <input type="number" id="quantity${itemIndex}" name="quantity${itemIndex}" required>
                    <label for="price${itemIndex}">Unit Price:</label>
                    <input type="number" id="price${itemIndex}" name="price${itemIndex}" required>
                `;

                itemsContainer.appendChild(newItem);
            });

            invoiceForm.addEventListener("submit", async(event)=>{
                event.preventDefault();

                const clientName = document.getElementById("clientName").value;
                const email = document.getElementById("email").value || "";
                const carModel = document.getElementById("carModel").value;
                const carColor = document.getElementById("carColor").value;
                const licencePlate = document.getElementById("licencePlate").value;
                const laborCost = parseFloat(document.getElementById("laborCost").value||0);
                const items = [];

                for (let i=0; i<itemsContainer.children.length; i++) {
                    const description = document.getElementById(`description${i+1}`).value;
                    const quantity = parseInt(document.getElementById(`quantity${i+1}`).value, 10);
                    const price = parseFloat(document.getElementById(`price${i+1}`).value);
                    items.push({ description, quantity, price });
                }
                console.log("Items:", items);

                const CANADIAN_TAX_RATE = 0.13;
                const itemsTotal = items.reduce((acc, item) => acc + item.quantity * item.price, 0);
                const total = laborCost + itemsTotal;
                const tax = total * CANADIAN_TAX_RATE;
                const grandTotal = total + tax;
                const invoice = { clientName, email, carModel, carColor, licencePlate, items, laborCost, tax, total: grandTotal };

                const url = editingInvoiceId ? `/api/invoices/${editingInvoiceId}` : "/api/invoices";
                const method = editingInvoiceId ? "PUT" : "POST";

                console.log(`Submitting invoice. Method: ${method}, URL: ${url}, editingInvoiceId: ${editingInvoiceId}`);

                try {
                    const response = await fetch(url, {
                        method: method,
                        headers: {
                            "Content-Type": "application/json",
                            "Authorization": `Bearer ${token}`
                        },
                        body: JSON.stringify(invoice)
                    });
                    if (response.ok) {
                        invoicePopup.style.display = "none";
                        loadInvoices();
                        toastr.options = {
                            closeButton: true,
                            progressBar: true,
                            timeOut: 2000, // Set timeout to 2 seconds
                            extendedTimeOut: 0,
                            tapToDismiss: false
                        };
                        toastr.success(`Invoice ${editingInvoiceId ? "updated" : "created"} successfully`);
                    }else {
                        const errorData = await response.json();
                        toastr.options = {
                            closeButton: true,
                            progressBar: true,
                            timeOut: 2000, // Set timeout to 2 seconds
                            extendedTimeOut: 0,
                            tapToDismiss: false
                        };
                        toastr.error(`Failed to ${editingInvoiceId ? "update" : "create"} invoice: ${errorData.msg}`);
                    }

                }catch (error){
                    console.error(`Error ${editingInvoiceId ? "updating" : "create"} invoice: ${error.msg}`);
                    toastr.options = {
                        closeButton: true,
                        progressBar: true,
                        timeOut: 2000, // Set timeout to 2 seconds
                        extendedTimeOut: 0,
                        tapToDismiss: false
                    };
                    toastr.error(`Error ${editingInvoiceId ? "updating" : "creating"} invoice`);
                }

                editingInvoiceId = null;
                invoiceForm.reset();
                itemsContainer.innerHTML = `
                    <div class="item">
                        <label for="description1">Description:</label>
                        <input type="text" id="description1" name="description1" required>
                        <label for="quantity1">Quantity:</label>
                        <input type="number" id="quantity1" name="quantity1" required>
                        <label for="price1">Unit Price:</label>
                        <input type="number" id="price1" name="price1" required>
                    </div>
                `;

            });

            cancelEditButton.addEventListener("click", ()=>{
                closeInvoiceForm();
                document.body.classList.remove("freeze-scroll");
            });

            const loadInvoices = async () => {
                try {
                    const response = await fetch("/api/invoices", {
                        headers : {
                            "Authorization": `Bearer ${token}`
                        }
                    });

                    const invoices = await response.json();
                    const invoiceTableBody = document.getElementById("invoiceTableBody");

                    invoiceTableBody.innerHTML = "";

                    invoices.forEach(invoice=>{
                        const row = document.createElement("tr");

                        row.innerHTML = `
                            <td>${invoice.InvoiceId}</td>
                            <td>${invoice.clientName}</td>
                            <td>${invoice.email}</td>
                            <td>${invoice.carModel}</td>
                            <td>${invoice.carColor}</td>
                            <td>${invoice.licencePlate}</td>
                            <td>${new Date(invoice.date).toLocaleDateString()}</td>
                             <td>${new Date(invoice.time).toLocaleTimeString()}</td>
                            <td>${(invoice.laborCost || 0).toFixed(2)}</td>
                            <td>${(invoice.tax || 0).toFixed(2)}</td>
                            <td>${(invoice.total || 0).toFixed(2)}</td>
                            <td>
                                <a href = "#" class = "view" data-id="${invoice._id}">View</a>
                            </td>
                        
                        `;
                        
                        invoiceTableBody.appendChild(row);
                    });

                    document.querySelectorAll(".view").forEach(viewButton=>{
                        viewButton.addEventListener("click", async (event) => {
                            event.preventDefault();
                            const invoiceId = viewButton.getAttribute("data-id");
                            const invoice = invoices.find(inv=>inv._id===invoiceId);
                            console.log("Invoice to be shown", invoice);
                            currentInvoice = invoice;
                            showInvoiceDetails(invoice);
                            document.body.classList.add("freeze-scroll");
                        });
                    });

                }catch (error){
                    console.error("Error loading invoices", error);
                    errorDisplay.textContent = `Error: ${error.message}`;
                    errorDisplay.style.display = "block";
                }
            };

            const loadCustomerEmails = async () => {
                try{
                    const response = await fetch("/api/auth/customers/emails",{
                        headers: {
                            "Authorization": `Bearer ${token}`
                        }
                    });

                    const emails = await response.json();
                    const emailList = document.getElementById("emailList");
                    emails.forEach(email=>{
                        if(email){
                            const option = document.createElement("option");
                            option.value = email;
                            emailList.appendChild(option);
                        }
                    });
                }catch {
                    console.error("Error loading customer emails:", error);
                }
            };

            const openInvoiceForm = (invoice = null) => {
                editingInvoiceId = invoice ? invoice._id : null;
                document.getElementById("clientName").value = invoice ? invoice.clientName : "";
                document.getElementById("email").value = invoice ? invoice.email : "";
                document.getElementById("carModel").value = invoice ? invoice.carModel : "";
                document.getElementById("carColor").value = invoice ? invoice.carColor : "";
                document.getElementById("licencePlate").value = invoice ? invoice.licencePlate : "";
                document.getElementById("laborCost").value = invoice ? invoice.laborCost : "";

                itemsContainer.innerHTML = "";

                if (invoice && invoice.items) {
                    invoice.items.forEach((item, index)=>{
                        const itemIndex = index + 1;
                        const newItem = document.createElement("div");
                        newItem.classList.add("item");
                        newItem.innerHTML = `
                            <label for="description${itemIndex}">Description:</label>
                            <input type="text" id="description${itemIndex}" name="description${itemIndex}" value="${item.description}" required>
                            <label for="quantity${itemIndex}">Quantity:</label>
                            <input type="number" id="quantity${itemIndex}" name="quantity${itemIndex}" value="${item.quantity}" required>
                            <label for="price${itemIndex}">Unit Price:</label>
                            <input type="number" id="price${itemIndex}" name="price${itemIndex}" value="${item.price}" required>
                        `;
                        itemsContainer.appendChild(newItem);
                    });
                }else {
                    itemsContainer.innerHTML = `
                        <div class="item">
                            <label for="description1">Description:</label>
                            <input type="text" id="description1" name="description1" required>
                            <label for="quantity1">Quantity:</label>
                            <input type="number" id="quantity1" name="quantity1" required>
                            <label for="price1">Unit Price:</label>
                            <input type="number" id="price1" name="price1" required>
                        </div>
                    
                    `;
                }

                formTitle.textContent = invoice ? "Edit Invoice" : "Create Invoice";
                submitInvoiceButton.textContent = invoice? "Save Changes" : "Create Invoice";
                cancelEditButton.style.display = invoice ? "inline-block" : "none";

                invoicePopup.style.display = "block"
            };

            const closeInvoiceForm = () => {
                invoicePopup.style.display = "none";
                editingInvoiceId = null;
                invoiceForm.reset();
                itemsContainer.innerHTML = `
                    <div class="item">
                        <label for="description1">Description:</label>
                        <input type="text" id="description1" name="description1" required>
                        <label for="quantity1">Quantity:</label>
                        <input type="number" id="quantity1" name="quantity1" required>
                        <label for="price1">Unit Price:</label>
                        <input type="number" id="price1" name="price1" required>
                    </div>
                `;
            };

            const showInvoiceDetails = (invoice) => {
                console.log("showInvoiceDetails called with:", invoice);
                const itemsHtml = invoice.items.map(item=>`
                    <tr>
                        <td>Description: ${item.description}</td>
                        <td>Quantity: ${item.quantity}</td>
                        <td>Price: ${((item.price*item.quantity) || 0).toFixed(2)}</td>
                    </tr>
                
                `).join("");
                invoiceDetails.innerHTML = `
                    <table>
                        <tr><th>Invoice ID</th><td>${invoice.InvoiceId}</td></tr>
                        <tr><th>Client Name</th><td>${invoice.clientName}</td></tr>
                        <tr><th>Email</th><td>${invoice.email || "N/A"}</td></tr>
                        <tr><th>Car Model</th><td>${invoice.carModel || "N/A"}</td></tr>
                        <tr><th>Car Color</th><td>${invoice.carColor || "N/A"}</td></tr>
                        <tr><th>Licence Plate</th><td>${invoice.licencePlate || "N/A"}</td></tr>
                        <tr><th>Date</th><td>${new Date(invoice.date).toLocaleDateString()}</td></tr>
                        <tr><th>Date</th><td>${new Date(invoice.time).toLocaleTimeString()}</td></tr>
                        <tr><th>Labor Cost</th><td>${(invoice.laborCost || 0).toFixed(2)}</td></tr>
                        <tr><th>Tax</th><td>${(invoice.tax || 0).toFixed(2)}</td></tr>
                        <tr><th>Total</th><td>${(invoice.total || 0).toFixed(2)}</td></tr>
                    </table>
                    <table>
                        <thread>
                            <th>Description</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                        </thread>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>
                
                `;
                invoiceDetailsPopup.style.display = "block";
                
                editInvoiceButton.addEventListener("click", () => {
                    closeInvoiceDetails();
                    openInvoiceForm(invoice);
                });

                deleteInvoiceButton.addEventListener("click", async ()=>{
                    confirmDelete(async(confirm) => {
                        if(confirm) {
                            try{
                                const response = await fetch(`/api/invoices/${invoice._id}`,{
                                    method: "DELETE",
                                    headers: {
                                        "Authorization": `Bearer ${token}`
                                    }
                                });
            
                                if (response.ok) {
                                    console.log("Invoice deleted successfully");
                                    invoiceDetailsPopup.style.display = "none";
                                    loadInvoices();
                                    toastr.options = {
                                        closeButton: true,
                                        progressBar: true,
                                        timeOut: 2000, // Set timeout to 2 seconds
                                        extendedTimeOut: 0,
                                        tapToDismiss: false
                                    };
                                    toastr.success("Invoice deleted successfully");
                                    
                                }else{
                                    const errorData = await response.json();
                                    toastr.options = {
                                        closeButton: true,
                                        progressBar: true,
                                        timeOut: 2000, // Set timeout to 2 seconds
                                        extendedTimeOut: 0,
                                        tapToDismiss: false
                                    };
                                    toastr.error(`Failed to delete invoice: ${errorData.msg}`);
                                }
                            }catch (error){
                                console.error("Error deleting invoice", error);
                                toastr.options = {
                                    closeButton: true,
                                    progressBar: true,
                                    timeOut: 2000, // Set timeout to 2 seconds
                                    extendedTimeOut: 0,
                                    tapToDismiss: false
                                };
                                toastr.error("Error deleting invoice");
                            }
                        }else {
                            toastr.options = {
                                closeButton: true,
                                progressBar: true,
                                timeOut: 2000, // Set timeout to 2 seconds
                                extendedTimeOut: 0,
                                tapToDismiss: false
                            };
                            toastr.info("Invoice deletion cancelled");
                        }
                    });
                });
                
            };

            function confirmDelete(callback)  {
                toastr.clear();
                toastr.options = {
                    closeButton: true,
                    progressBar: true,
                    timeOut: 0,
                    extendedTimeOut: 0,
                    tapToDismiss: false,
                    onShown: function() {
                        document.getElementById("confirmBtn").addEventListener("click", function () {
                            toastr.remove();
                            callback(true);
                            
                        });
                        document.getElementById("cancelBtn").addEventListener("click", function () {
                            toastr.remove();
                            callback(false);
                            
                        });
                    }
                   
                };
                const message = `
                    <div>
                        <p>Are you sure you want to delete this invoice ?</p>
                        <button id="confirmBtn" class="btn btn-danger">Yes</button>
                        <button id="cancelBtn" class="btn btn-secondary">No</button>
                    </div>
                `;
                toastr.warning(message);
            }
            
            downloadPdfButton.addEventListener("click", async ()=> {
                const invoiceDetailsElement = document.getElementById("invoiceDetails");
                const invoice = currentInvoice;
                if (!invoice) {
                    console.error("No invoice to generate PDF");
                    return;
                }
                console.log("Converting to PDF...");
                /*
                try{
                    const pdf = new jsPDF();
                    const invoiceContent = `

                        <h1> Invoice </h1>
                        <p><strong>Invoice ID:</strong>${invoice.InvoiceId}</p>
                        <p><strong>Client Name:</strong>${invoice.clientName}</p>
                        <p><strong>Email:</strong>${invoice.email}</p>
                        <p><strong>Car Model:</strong>${invoice.carModel}</p>
                        <p><strong>Car Color:</strong>${invoice.carColor}</p>
                        <p><strong>Licence Plate:</strong>${invoice.licencePlate}</p>
                        <p><strong>Date:</strong>${new Date(invoice.date).toLocaleDateString()}</p>
                        <p><strong>Date:</strong>${new Date(invoice.time).toLocaleTimeString()}</p>
                        <p><strong>Labor Cost:</strong>${(invoice.laborCost || 0).toFixed(2)}</p>
                        <p><strong>Tax:</strong>${(invoice.tax || 0).toFixed(2)}</p>
                        <p><strong>Total:</strong>${(invoice.total || 0).toFixed(2)}</p>
                        <h2>Items</h2>
                        <table>
                            <thead>
                                <th>Description</th>
                                <th>quantity</th>
                                <th>Unit Price</th>
                            </thead>
                            <tbody>
                                ${invoice.items.map(item => `
                                    <tr>
                                        <td>${item.description}</td>
                                        <td>${item.quantity}</td>
                                        <td>${item.price.toFixed(2)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    
                    `;

                    const invoiceElement = document.createElement("div");
                    invoiceElement.innerHTML = invoiceContent;

                    await pdf.html(invoiceElement, {
                        callback: function(pdf) {
                            pdf.save("invoice.pdf");
                        }, 
                        x : 10,
                        y : 10
                    });
                    

                }catch(error) {
                    console.error("Error creating PDF", error);
                }
                    */
                    try {
                        const pdf = new jsPDF();
                        const logoUrl = '/images/logo.png';  // Path to your logo
                        const logoImg = new Image();
                        logoImg.src = logoUrl;
                
                        logoImg.onload = () => {
                            console.log("Logo loaded successfully");
                            pdf.addImage(logoImg, 'PNG', 80, 10, 50, 25);  // Adjust the logo size and position
                            console.log("Logo added to PDF");
                
                            // Garage Information
                            pdf.setFontSize(12);
                            pdf.text("Autoelit Inc.", 10, 10);
                            pdf.text("3354 Sources Blvd,", 10, 15);
                            pdf.text("Dollard-Des Ormeaux, Quebec H9B 1Z9", 10, 20);
                            pdf.text("(514) 822-4449", 10, 25);
                            pdf.text("autoelite2008@live.ca", 10, 30);
                            console.log("Garage info added");
                
                            // Invoice Information
                            pdf.setFontSize(14);
                            pdf.text("Invoice", 180, 10, { align: "right" });
                            pdf.setFontSize(12);
                            pdf.text(`Date: ${new Date(invoice.date).toLocaleDateString()}`, 180, 20, { align: "right" });
                            pdf.text(`Time: ${new Date(invoice.time).toLocaleTimeString()}`, 180, 25, { align: "right" });
                            console.log("Invoice header added");
                
                            // Separator Line
                            pdf.line(10, 35, 200, 35);
                            console.log("Separator line added");
                
                            // Invoice Details Table
                            const invoiceDetails = [
                                ["Invoice ID", invoice.InvoiceId],
                                ["Client Name", invoice.clientName],
                                ["Email", invoice.email || "N/A"],
                                ["Car Model", invoice.carModel],
                                ["Car Color", invoice.carColor],
                                ["Licence Plate", invoice.licencePlate],
                                ["Labor Cost", `$${(invoice.laborCost || 0).toFixed(2)}`]
                            ];
                
                            pdf.autoTable({
                                startY: 40,
                                head: [["Detail", "Value"]],
                                body: invoiceDetails.map(detail => [{content: detail[0], styles: {fontStyle: "bold"}}, detail[1]]),
                                theme: "striped"
                            });
                
                            console.log("Invoice details added");
                            const tableFinalY = pdf.lastAutoTable.finalY + 10;
                
                            // Items Table
                            pdf.setFontSize(14);
                            pdf.text("Items", 10, tableFinalY);
                            pdf.setFontSize(12);
                
                            pdf.autoTable({
                                startY: tableFinalY + 10,
                                head: [['Description', 'Quantity', 'Unit Price']],
                                body: invoice.items.map(item => [item.description, item.quantity, `$${item.price.toFixed(2)}`]),
                                margin: { top: 10 }
                            });
                            console.log("Items table added");
                         
                            const itemsTableFinalY = pdf.lastAutoTable.finalY + 10;
                            
                            // Total and Tax
                            pdf.text(`Tax: $${(invoice.tax || 0).toFixed(2)}`, 160, itemsTableFinalY, { align: "right" });
                            pdf.text(`Total: $${(invoice.total || 0).toFixed(2)}`, 160, itemsTableFinalY + 10, { align: "right" });
                            console.log("Total and tax added");
                
                            // Save the PDF
                            pdf.save("invoice.pdf");
                            console.log("PDF saved");
                        };
                
                        logoImg.onerror = (err) => {
                            console.error("Error loading logo image", err);
                        };
                    } catch (error) {
                        console.error("Error creating PDF", error);
                    }
               
            });

            const closeInvoiceDetails = () => {
                invoiceDetailsPopup.style.display = "none";
                document.getElementById("invoiceDetails").innerHTML = "";
            };

            loadInvoices();
            loadCustomerEmails();
        });
    </script>
</body>
</html>